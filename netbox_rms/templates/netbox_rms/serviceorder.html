{% extends 'generic/object.html' %}
{% load helpers %}
{% load i18n %}
{% load render_table from django_tables2 %}

{% block title %}{{ object.order_no }}{% endblock %}

{% block breadcrumbs %}
{{ block.super }}
<li class="breadcrumb-item">
    <a href="{% url 'plugins:netbox_rms:serviceorder_list' %}">{% trans "业务主工单" %}</a>
</li>
<li class="breadcrumb-item active">{{ object.order_no }}</li>
{% endblock %}

{% block extra_head %}
<style>
    .card table.attr-table {
        table-layout: fixed;
        width: 100%;
    }
    .card .attr-table th,
    .card table.attr-table th {
        width: 38.2% !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    {# 左侧列：申请信息、资源核查、核查结果 #}
    <div class="col col-md-6">
        {# 申请信息卡片 #}
        <div class="card mb-3">
            <h5 class="card-header">{% trans "申请信息" %}</h5>
            <table class="table table-hover attr-table" style="table-layout: fixed;">
                <colgroup>
                    <col style="width: 38.2%;">
                    <col>
                </colgroup>
                <tr>
                    <th scope="row">{% trans "业务单号" %}</th>
                    <td>{{ object.order_no }}</td>
                </tr>
                <tr>
                    <th scope="row">{% trans "客户单位" %}</th>
                    <td>
                        {% if object.tenant %}
                            <a href="{{ object.tenant.get_absolute_url }}">{{ object.tenant.name }}</a>
                        {% else %}
                            {{ ''|placeholder }}
                        {% endif %}
                    </td>
                </tr>

                <tr>
                    <th scope="row">{% trans "销售负责人" %}</th>
                    <td>{{ object.sales_contact }}</td>
                </tr>
                <tr>
                    <th scope="row">{% trans "商务负责人" %}</th>
                    <td>{{ object.business_manager|placeholder }}</td>
                </tr>
                <tr>
                    <th scope="row">{% trans "内部参与方" %}</th>
                    <td>{{ object.get_internal_participant_display|placeholder }}</td>
                </tr>
                <tr>
                    <th scope="row">{% trans "申请时间" %}</th>
                    <td>{{ object.apply_date|date:"Y年n月j日" }}</td>
                </tr>
                <tr>
                    <th scope="row">{% trans "计划开通时间" %}</th>
                    <td>{{ object.deadline_date|date:"Y年n月j日" }}</td>
                </tr>
            </table>
        </div>



        {# 资源核查卡片 #}
        {% if object.check_type %}
        <div class="card mb-3">
            <h5 class="card-header">{% trans "资源核查" %}</h5>
            <table class="table table-hover attr-table" style="table-layout: fixed;">
                <colgroup>
                    <col style="width: 38.2%;">
                    <col>
                </colgroup>
                <tr>
                    <th scope="row">{% trans "业务类别" %}</th>
                    <td><span class="badge bg-{{ object.get_check_type_color }}" style="color: #fff !important">{{ object.get_check_type_display }}</span></td>
                </tr>
                {% if object.check_type == 'transmission' %}
                    <tr>
                        <th scope="row">{% trans "带宽" %}</th>
                        <td>{{ object.safe_check_data.bandwidth|default_if_none:""|placeholder }}</td>
                    </tr>
                    <tr>
                        <th scope="row">{% trans "数量" %}</th>
                        <td>{{ object.safe_check_data.quantity|default_if_none:""|placeholder }}</td>
                    </tr>
                    <tr>
                        <th scope="row">{% trans "A端站点" %}</th>
                        <td>
                            {% if object.site_a_object %}
                                <a href="{{ object.site_a_object.get_absolute_url }}">{{ object.safe_check_data.site_a_name|default:object.site_a_object.name }}</a>
                            {% else %}
                                {{ object.safe_check_data.site_a_name|default_if_none:""|placeholder }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">{% trans "Z端站点" %}</th>
                        <td>
                            {% if object.site_z_object %}
                                <a href="{{ object.site_z_object.get_absolute_url }}">{{ object.safe_check_data.site_z_name|default:object.site_z_object.name }}</a>
                            {% else %}
                                {{ object.safe_check_data.site_z_name|default_if_none:""|placeholder }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">{% trans "需要保护" %}</th>
                        <td>{% if object.safe_check_data.needs_protection %}{% trans "是" %}{% else %}{% trans "否" %}{% endif %}</td>
                    </tr>
                    <tr>
                        <th scope="row">{% trans "接口类型" %}</th>
                        <td><span class="badge bg-{{ object.get_interface_type_color }}" style="color: #fff !important">{{ object.interface_type_display|placeholder }}</span></td>
                    </tr>
                {% elif object.check_type == 'fiber' %}
                    <tr>
                        <th scope="row">{% trans "数量" %}</th>
                        <td>{{ object.safe_check_data.quantity|default_if_none:""|placeholder }}</td>
                    </tr>
                    <tr>
                        <th scope="row">{% trans "A端站点" %}</th>
                        <td>
                            {% if object.site_a_object %}
                                <a href="{{ object.site_a_object.get_absolute_url }}">{{ object.safe_check_data.site_a_name|default:object.site_a_object.name }}</a>
                            {% else %}
                                {{ object.safe_check_data.site_a_name|default_if_none:""|placeholder }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">{% trans "Z端站点" %}</th>
                        <td>
                            {% if object.site_z_object %}
                                <a href="{{ object.site_z_object.get_absolute_url }}">{{ object.safe_check_data.site_z_name|default:object.site_z_object.name }}</a>
                            {% else %}
                                {{ object.safe_check_data.site_z_name|default_if_none:""|placeholder }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">{% trans "需要保护" %}</th>
                        <td>{% if object.safe_check_data.needs_protection %}{% trans "是" %}{% else %}{% trans "否" %}{% endif %}</td>
                    </tr>
                    <tr>
                        <th scope="row">{% trans "接口类型" %}</th>
                        <td><span class="badge bg-{{ object.get_interface_type_color }}" style="color: #fff !important">{{ object.interface_type_display|placeholder }}</span></td>
                    </tr>
                {% elif object.check_type == 'colocation' %}
                    <tr>
                        <th scope="row">{% trans "机房" %}</th>
                        <td>
                            {% if object.colocation_site_object %}
                                <a href="{{ object.colocation_site_object.get_absolute_url }}">{{ object.safe_check_data.site_name|default:object.colocation_site_object.name }}</a>
                            {% else %}
                                {{ object.safe_check_data.site_name|default_if_none:""|placeholder }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">{% trans "出局纤芯数" %}</th>
                        <td>{{ object.safe_check_data.egress_fiber_cores|default_if_none:""|placeholder }}</td>
                    </tr>
                {% endif %}
            </table>
            {% if object.check_type == 'colocation' and object.safe_check_data.devices %}
            <div class="card-body">
                <h6>{% trans "托管设备列表" %}</h6>
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>{% trans "设备类型" %}</th>
                            <th>{% trans "品牌型号" %}</th>
                            <th>{% trans "尺寸(长×宽×高)" %}</th>
                            <th>{% trans "机架需求(U)" %}</th>
                            <th>{% trans "单台能耗(W)" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in object.safe_check_data.devices %}
                        <tr>
                            <td>{% if device.device_type == 'transmission' %}传输设备{% elif device.device_type == 'switch' %}交换机{% elif device.device_type == 'router' %}路由器{% elif device.device_type == 'other' %}其他{% else %}{{ device.device_type }}{% endif %}</td>
                            <td>{{ device.model|default_if_none:"" }}</td>
                            <td>{{ device.length }}×{{ device.width }}×{{ device.height }}</td>
                            <td>{{ device.rack_units }}</td>
                            <td>{{ device.power_consumption }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>

        {# 核查结果卡片 #}
        <div class="card mb-3">
            <h5 class="card-header d-flex justify-content-between align-items-center">
                {% trans "核查结果" %}
                {% if object.check_result_obj %}
                    {% if perms.netbox_rms.change_resourcecheckresult %}
                        <a href="{% url 'plugins:netbox_rms:resourcecheckresult_edit' pk=object.check_result_obj.pk %}?return_url={{ object.get_absolute_url }}" class="btn btn-sm btn-warning">
                            <i class="mdi mdi-pencil" aria-hidden="true"></i> {% trans "编辑" %}
                        </a>
                    {% endif %}
                {% else %}
                    {% if perms.netbox_rms.add_resourcecheckresult %}
                        <a href="{% url 'plugins:netbox_rms:resourcecheckresult_add' %}?service_order={{ object.pk }}&return_url={{ object.get_absolute_url }}" class="btn btn-sm btn-primary">
                            <i class="mdi mdi-plus-thick" aria-hidden="true"></i> {% trans "添加" %}
                        </a>
                    {% endif %}
                {% endif %}
            </h5>
            <table class="table table-hover attr-table" style="table-layout: fixed;">
                <colgroup>
                    <col style="width: 38.2%;">
                    <col>
                </colgroup>
                <tr>
                    <th scope="row">{% trans "核查结果" %}</th>
                    <td>
                        {% if object.check_result == 'available' %}
                            <span class="text-success"><i class="mdi mdi-check-bold"></i> {% trans "具备" %}</span>
                        {% elif object.check_result == 'unavailable' %}
                            <span class="text-danger"><i class="mdi mdi-close-thick"></i> {% trans "不具备" %}</span>
                        {% else %}
                            {{ ''|placeholder }}
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th scope="row">{% trans "不具备原因" %}</th>
                    <td>
                        {% if object.safe_unavailable_reasons %}
                            {% if object.check_type == 'transmission' %}
                                {# 传输专线：多选原因 #}
                                {% with reasons=object.safe_unavailable_reasons %}
                                {% if 'wavelength' in reasons %}{% trans "波道不满足" %}{% if 'module' in reasons or 'card' in reasons or 'protection' in reasons %}、{% endif %}{% endif %}{% if 'module' in reasons %}{% trans "模块不满足" %}{% if 'card' in reasons or 'protection' in reasons %}、{% endif %}{% endif %}{% if 'card' in reasons %}{% trans "板卡不满足" %}{% if 'protection' in reasons %}、{% endif %}{% endif %}{% if 'protection' in reasons %}{% trans "成环保护不满足" %}{% endif %}
                                {% endwith %}
                            {% elif object.check_type == 'fiber' %}
                                {# 光缆光纤：多选原因 #}
                                {% with reasons=object.safe_unavailable_reasons %}
                                {% if 'fiber' in reasons %}{% trans "光纤不满足" %}{% if 'protection' in reasons %}、{% endif %}{% endif %}{% if 'protection' in reasons %}{% trans "成环保护不满足" %}{% endif %}
                                {% endwith %}
                            {% elif object.check_type == 'colocation' %}
                                {# 托管业务：多选原因 #}
                                {% with reasons=object.safe_unavailable_reasons %}
                                {% if 'cabinet' in reasons %}{% trans "机柜不满足" %}{% if 'power' in reasons or 'space' in reasons or 'fiber' in reasons %}、{% endif %}{% endif %}{% if 'power' in reasons %}{% trans "配电不满足" %}{% if 'space' in reasons or 'fiber' in reasons %}、{% endif %}{% endif %}{% if 'space' in reasons %}{% trans "机柜空间不满足" %}{% if 'fiber' in reasons %}、{% endif %}{% endif %}{% if 'fiber' in reasons %}{% trans "引接纤芯不满足" %}{% endif %}
                                {% endwith %}
                            {% endif %}
                        {% else %}
                            {{ ''|placeholder }}
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th scope="row">{% trans "说明" %}</th>
                    <td>{{ object.check_result_obj.description|placeholder }}</td>
                </tr>
            </table>
        </div>
        {% endif %}

        {# 执行信息卡片 #}
        <div class="card mb-3">
            <h5 class="card-header">{% trans "执行信息" %}</h5>
            <table class="table table-hover attr-table" style="table-layout: fixed;">
                <colgroup>
                    <col style="width: 38.2%;">
                    <col>
                </colgroup>
                <tr>
                    <th scope="row">{% trans "项目报备编号" %}</th>
                    <td>{{ object.project_report_code|placeholder }}</td>
                </tr>
                <tr>
                    <th scope="row">{% trans "立项编号" %}</th>
                    <td>{{ object.project_approval_code|placeholder }}</td>
                </tr>
                <tr>
                    <th scope="row">{% trans "合同编号" %}</th>
                    <td>{{ object.contract_code|placeholder }}</td>
                </tr>
                <tr>
                    <th scope="row">{% trans "确认执行状态" %}</th>
                    <td>{{ object.get_confirmation_status_display|placeholder }}</td>
                </tr>
                <tr>
                    <th scope="row">{% trans "起租日期" %}</th>
                    <td>{{ object.billing_start_date|date:"Y年n月j日" }}</td>
                </tr>
                <tr>
                    <th scope="row">{% trans "特殊情况说明" %}</th>
                    <td>{{ object.special_notes|placeholder }}</td>
                </tr>
            </table>
        </div>
    </div>

    {# 右侧列：标签、评论 #}
    <div class="col col-md-6">
        {# 标签卡片 #}
        <div class="card mb-3">
            <h5 class="card-header">{% trans "标签" %}</h5>
            <div class="card-body">
                {% if object.tags.all %}
                    {% for tag in object.tags.all %}
                        <a href="{% url 'extras:tag' pk=tag.pk %}" class="me-1">
                            <span class="badge rounded-pill" style="color: #fff; background-color: #{{ tag.color }}; font-size: 0.9em; padding: 0.5em 0.8em;">{{ tag.name }}</span>
                        </a>
                    {% endfor %}
                {% else %}
                    <span class="text-muted">{% trans "没有分配标签" %}</span>
                {% endif %}
            </div>
        </div>

        {# 评论卡片 #}
        <div class="card mb-3">
            <h5 class="card-header">{% trans "评论" %}</h5>
            <div class="card-body">
                {% if object.comments %}
                    {{ object.comments|markdown }}
                {% else %}
                    {% trans "无" %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# 执行任务表格 #}
<div class="row mb-3">
    <div class="col col-md-12">
        <div class="card">
            <h5 class="card-header">{% trans "执行任务" %}</h5>
            <div class="table-responsive">
                {% render_table tasks_table 'inc/table.html' %}
            </div>
        </div>
    </div>
</div>

{# 关联资源表格 #}
<div class="row mb-3">
    <div class="col col-md-12">
        <div class="card">
            <h5 class="card-header">{% trans "关联资源" %}</h5>
            <div class="table-responsive">
                {% render_table resources_table 'inc/table.html' %}
            </div>
        </div>
    </div>
</div>

{# 变更工单表格 #}
{% if child_orders_table.rows %}
<div class="row mb-3">
    <div class="col col-md-12">
        <div class="card">
            <h5 class="card-header">{% trans "变更工单" %}</h5>
            <div class="table-responsive">
                {% render_table child_orders_table 'inc/table.html' %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}
